version: '2'

vars:
  GIT_COMMIT: { sh: git rev-parse --short HEAD }

tasks:
  build:
    deps: [build-api, build-migrate]

  build-api:
    cmds:
      - go build -o bin/bibliotheca -v -i cmd/bibliotheca/main.go
    sources:
      - ./*.go
    generates:
      - bin/bibliotheca{{exeExt}}

  build-migrate:
    cmds:
      - go build -o bin/migrate -v -i cmd/migrate/main.go
    sources:
      - ./*.go
    generates:
      - bin/migrate{{exeExt}}

  build-container:
    cmds:
      - docker build --target app --tag "bibliotheca-go:$TAG" -f deployments/Dockerfile .
    env:
      TAG: "{{default .GIT_COMMIT .TAG}}"

  run:
    cmds:
      - go run cmd/bibliotheca/main.go

  migrate:
    cmds:
      - go run cmd/migrate/main.go

  fmt:
    cmds:
      - go fmt ./...

  dc-up:
    cmds:
      - docker-compose up -d db api
      - docker-compose logs -f

  dc-build:
    cmds:
      - docker-compose build

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
